import ROOT as rt
import numpy as np
import plotfactory as pf
import ntup_dir as nt
from glob import glob
import sys
from pdb import set_trace
from os.path import normpath, basename
####################################################################################################
outdir = '/eos/user/v/vstampf/ntuples/plots/id_efficiency/'
indir = nt.getntupdir()
####################################################################################################
ntdr = basename(normpath(indir))
####################################################################################################
t = pf.makechain(True)
####################################################################################################
####################################################################################################
pf.setpfstyle()
####################################################################################################
####################################################################################################
inc   = 'is_in_acc == 1 & l0_matched_electron_pt > 30 & l1_matched_muon_pt > 4 & l2_matched_muon_pt > 4'
loose = ' & l1_matched_muon_id_l & l2_matched_muon_id_l'
globl = ' & l1_matched_muon_is_gl & l2_matched_muon_is_gl'
emumu = ' & abs(l0_pdgId) == 11 & abs(l1_pdgId)==13 & abs(l2_pdgId) == 13 '
####################################################################################################
idgl  = inc + globl + emumu
idL   = inc + loose + emumu
denom = inc + emumu
####################################################################################################
b_2disp = np.arange(0.,200, 5)
####################################################################################################
####################################################################################################
h_eff_2disp_d      = rt.TH1F('eff_2disp_d','eff_2disp_d',len(b_2disp)-1,b_2disp)
h_eff_2disp_idL_n  = rt.TH1F('eff_2disp_idL_n','eff_2disp_idL_n',len(b_2disp)-1,b_2disp)
h_eff_2disp_idgl_n = rt.TH1F('eff_2disp_idgl_n','eff_2disp_idgl_n',len(b_2disp)-1,b_2disp)
####################################################################################################
####################################################################################################
####################################################################################################
t.Draw('hnl_2d_disp >> eff_2disp_idL_n' , idL)
t.Draw('hnl_2d_disp >> eff_2disp_idgl_n', idgl)
t.Draw('hnl_2d_disp >> eff_2disp_d'     , denom)
####################################################################################################
####################################################################################################
####################################################################################################
h_eff_idL = rt.TEfficiency(h_eff_2disp_idL_n, h_eff_2disp_d)
h_eff_idL.SetTitle('Loose Muon ID; 2D displacement [cm]; #varepsilon') 
h_eff_idL.SetMarkerColor(rt.kBlue+2)
h_eff_idgl = rt.TEfficiency(h_eff_2disp_idgl_n, h_eff_2disp_d)
h_eff_idgl.SetTitle('Global Muon ID; 2D displacement [cm]; #varepsilon') 
h_eff_idgl.SetMarkerColor(rt.kGreen+2)
####################################################################################################
####################################################################################################
c_eff_idL = rt.TCanvas('eff_idL','eff_idL')
c_eff_idgl = rt.TCanvas('eff_idgl','eff_idgl')
c_eff_ids = rt.TCanvas('eff_ids','eff_ids')
####################################################################################################
####################################################################################################
clist = [c_eff_idgl,c_eff_idL,c_eff_ids]
####################################################################################################
####################################################################################################
c_eff_idL.cd()
h_eff_idL.Draw()
####################################################################################################
c_eff_idgl.cd()
h_eff_idgl.Draw()
####################################################################################################
c_eff_ids.cd()
h_eff_idL.Draw()
h_eff_idgl.Draw('same')
c_eff_ids.BuildLegend()
####################################################################################################
####################################################################################################
for c in clist:
    c.cd()
    pf.showlogoprelimsim('CMS')
#    rt.gStyle.SetOptStat()
    c.Modified()
    c.Update()
    c.SaveAs(outdir+c.GetTitle()+'_'+ntdr+'.root')
    c.SaveAs(outdir+c.GetTitle()+'_'+ntdr+'.png')
    c.SaveAs(outdir+c.GetTitle()+'_'+ntdr+'.pdf')
